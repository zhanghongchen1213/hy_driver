---
name: "embedded-serial-log-analysis"
description: "分析嵌入式串口错误日志，自动定位代码根源（单文件或全项目），分析原因并直接修复代码。当用户提供串口日志要求分析或修复bug时调用。"
---

# 嵌入式串口日志分析与修复 (Embedded Serial Log Analysis & Fix)

本技能专注于通过分析嵌入式设备的串口打印日志（Serial Logs），自动定位代码中的错误根源，提供详细的问题分析与解决方案，并直接修改代码进行修复。

## 目标 (Goals)

1.  **日志解析 (Log Parsing)**：从串口输出中提取关键错误信息（如断言失败、HardFault 寄存器值、Panic 消息、错误码）。
2.  **自动定位 (Auto-Localization)**：
    - 如果用户指定了文件，重点在指定文件中查找问题。
    - 如果未指定文件，在整个项目中搜索错误关键字或相关逻辑。
3.  **根因分析 (Root Cause Analysis)**：结合代码上下文，推断错误的成因（如堆栈溢出、空指针解引用、时序竞争、硬件初始化失败）。
4.  **自动修复 (Auto-Fix)**：生成具体的修复代码并直接应用到源文件中。

## 执行流程 (Execution Flow)

当用户提供一段串口日志（可能包含 `ASSERT`, `HardFault`, `Error`, `[E]`, `[F]` 等关键词）时：

### 1. 初步分析与定位 (Analysis & Localization)

- **提取特征**：识别日志中的文件名、行号、函数名、错误码或异常地址。
- **搜索代码**：
  - 若日志包含明确的文件名/行号（如 `main.c:128 Assertion failed`），直接读取对应文件。
  - 若仅有错误文本（如 `Connection timeout`），使用全局搜索 (`Grep`/`SearchCodebase`) 定位打印该日志的代码位置。

### 2. 根因诊断 (Diagnosis)

- 阅读定位点周围的代码上下文。
- 结合日志中的变量值或寄存器状态，分析逻辑漏洞。
- **常见场景**：
  - **断言失败 (Assert)**：检查导致条件不成立的前置逻辑。
  - **HardFault/Panic**：分析可能的非法指针访问、除零、堆栈溢出。
  - **超时/状态错误**：分析状态机流转或中断标志位处理。

### 3. 制定与执行修复 (Fix Execution)

- **方案制定**：提出具体的修改建议（如增加判空检查、修改缓冲区大小、调整延时、修正逻辑判断）。
- **代码修改**：生成具体的修复代码并直接应用到源文件中。
- **验证建议**：告知用户修复后的预期行为，或建议如何验证修复（如“请重新编译并观察是否仍有 HardFault”）。

## 交互示例 (Example)

**用户输入**：

> "串口打印了这个错误，帮我修一下：
> `[E] [WIFI] buffer_alloc.c:45: Alloc failed, size=10240, heap_free=5120`"

**模型响应**：

1.  **定位**：识别到 `buffer_alloc.c` 第 45 行。
2.  **分析**：请求分配 10KB 内存，但剩余堆空间仅 5KB，导致分配失败。
3.  **修复**：
    - _方案 A_：增加堆大小（如果硬件允许）。
    - _方案 B_：优化接收缓冲区大小。
    - _方案 C_：增加分配失败的保护逻辑（判空返回）。
    - _(自动选择最合理的修复，例如增加判空保护)_
4.  **行动**：修改 `buffer_alloc.c`，在第 45 行附近添加 `if (ptr == NULL) { return ERR_MEM; }`。

## 注意事项 (Notes)

- 在处理 **HardFault** 时，如果日志包含寄存器转储（R0-R15, LR, PC），优先尝试根据 PC/LR 值反查函数调用栈（如果环境允许）。
- 修改代码前，务必理解上下文，避免破坏原有的原子性操作或中断保护。

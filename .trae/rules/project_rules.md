# 嵌入式系统开发规范指南

## 核心开发理念

### 文件管理

- **示例文件**：所有实例文件代码和 markdown 格式文件都放到`example_code`目录下

### 基本原则

- **渐进式开发**：小步快跑，每次提交都能编译通过
- **代码学习**：先研究现有代码模式，再实现新功能
- **实用主义**：选择最直接有效的解决方案
- **清晰意图**：代码可读性优于技巧性

### 质量标准

- **单一职责**：函数/模块保持单一功能
- **避免过度设计**：不做过早抽象
- **错误处理**：快速失败，提供清晰错误信息
- **测试驱动**：关键功能必须有测试覆盖

## AI 编程助手配置

- **默认语言**：中文
- **项目类型**：嵌入式系统开发（ESP32-S3 平台）
- **编程语言**：C 语言（主要）/ C++（辅助）
- **目标平台**：ESP32-S3 MCU + FreeRTOS
- **开发框架**：ESP-IDF v5.x
- **思考策略**：系统性分析 → 渐进式实现 → 验证测试
- **调试信息**：
  - 使用`ESP_LOGI`等日志等级
  - 使用`ESP_LOGW`等日志等级
  - 使用`ESP`等日志输出时使用中文输出

## 自动修复策略

1. 检测到`magic number`时 → 建议替换为枚举或宏定义
2. 函数超过 50 行 → 提示拆分建议
3. 缺少错误处理 → 自动补全错误检查代码
4. 全局变量无`g_`前缀 → 自动重命名
5. 检测到阻塞调用 → 建议使用非阻塞或异步版本
6. 检测到未初始化变量 → 自动添加初始化
7. 检测到内存泄漏风险 → 提示添加 free()
8. 检测到中断上下文不安全调用 → 建议 ISR 安全版本
9. 检测到硬件寄存器直接访问 → 建议使用 HAL 层接口
10. 检测到功耗敏感操作 → 提示低功耗优化建议

## 文档生成规则

```doxygen
/// @module 模块名称
/// @brief 模块功能简要描述
/// @warning 重要注意事项和限制条件
/// @note 使用说明和特殊要求
/// @author ZHC 作者信息
/// @date 2025 创建/修改日期
/// @version 版本号
```

## 代码规范

### 1. 命名规范

- 文件命名：全小写，下划线分隔（例：`sensor_driver.c`）
- 函数命名：小写字母开头，下划线分隔（例：`gpio_init_pin`）
- 变量命名：
  - 全局变量：g\_前缀（例：`g_system_state`）
  - 静态变量：s\_前缀（例：`s_counter`）
  - 常量/宏定义：全大写，下划线分隔（例：`MAX_BUFFER_SIZE`）
  - 局部变量：小写，下划线分隔（例：`temp_value`）
- 结构体：名称后加\_t 后缀（例：`device_config_t`）
- 枚举类型：首字母大写，下划线分隔（例：`System_State`）
- 指针变量：p\_前缀（例：`p_buffer`）

### 2. 注释规范

- 文件头注释：包含版权信息、文件描述、作者、日期
- 函数注释：使用 Doxygen 风格

```c
/**
 * @brief  函数简要说明
 * @param  参数说明
 * @retval 返回值说明
 */
```

- 关键代码段注释：使用行注释说明功能
- 变量定义注释：复杂变量需要说明用途

### 3. 代码格式

- 缩进：4 个空格
- 大括号：独占一行
- 运算符前后加空格
- 每行不超过 80 字符
- 函数间空行分隔

### 4. 编程规范

- 避免使用全局变量，必要时使用 g\_前缀
- 使用 const 修饰只读参数
- 避免深层嵌套（不超过 3 层）
- 函数单一职责，不超过 50 行
- 使用枚举替代魔法数字
- 错误处理必须完整

### 5. 代码结构

- **保护现有代码**：不允许改变现有代码布局，只允许填充代码
- **头文件规范**：宏定义、结构体、函数声明放在.h 文件
- **源文件规范**：全局变量、函数实现放在.c 文件
- **ESP32 特定**：
  - ISR 函数必须使用`IRAM_ATTR`修饰
  - 频繁调用函数考虑使用`IRAM_ATTR`
  - 任务栈大小根据实际需求设置（建议 4KB 起步）
  - 使用`CONFIG_`宏进行条件编译

## 嵌入式系统特定规范

### 1. FreeRTOS 任务管理

- **任务优先级分配**：
  - 关键控制任务：优先级 20-24（最高）
  - 通信任务：优先级 15-19
  - 普通业务任务：优先级 10-14
  - 后台任务：优先级 5-9（最低）
- **任务栈大小**：根据实际需求设置，建议 4KB 起步
- **任务命名**：使用描述性名称，便于调试
- **任务创建**：使用`xTaskCreate()`或`xTaskCreatePinnedToCore()`

### 2. ESP32 内存管理

- **内存类型**：
  - IRAM：中断服务程序和频繁调用函数
  - DRAM：一般数据存储
  - PSRAM：大容量数据缓存（如果可用）
- **分配策略**：
  - 优先使用栈内存
  - 静态分配优于动态分配
  - 使用`heap_caps_malloc()`指定内存类型
- **内存保护**：
  - malloc()必须配对 free()
  - 避免在 ISR 中动态分配
  - 监控内存使用，防止泄漏

### 3. 中断处理

- ISR 函数保持简短，快速执行
- 避免在 ISR 中进行复杂计算和 I/O 操作
- 使用中断标志或队列与主程序通信
- 合理设置中断优先级
- 禁用中断时间尽可能短
- 中断嵌套层数控制在合理范围

### 4. 外设和 I/O 操作

- 外设初始化前检查时钟配置
- GPIO 配置包含方向、上拉/下拉、驱动能力设置
- 使用完外设后及时关闭以节省功耗
- 通信接口操作必须检查返回值和超时
- 使用 DMA 减少 CPU 负载
- 外设访问使用原子操作或临界区保护

### 5. 定时器和延时

- 根据精度要求选择合适的定时器
- 避免使用忙等待延时，影响系统效率
- 定时器回调函数保持简短
- 使用硬件定时器实现精确定时
- 软件定时器适用于非关键定时任务

## 实时系统约束

### 1. 时序要求

- 硬实时任务：必须在规定时间内完成
- 软实时任务：允许偶尔超时但不影响系统稳定性
- 关键控制循环：根据应用需求确定周期
- 中断响应时间：尽可能短，通常微秒级
- 任务切换开销：考虑上下文切换时间

### 2. 任务设计

- 单一职责原则：每个任务只负责一个功能
- 避免任务间强耦合，降低系统复杂度
- 使用消息队列、信号量进行任务通信
- 关键任务使用独立栈空间
- 任务优先级分配遵循 Rate Monotonic 原则

### 3. 资源管理

- 使用互斥量保护共享资源
- 避免优先级反转问题
- 实现死锁检测和预防机制
- 监控任务运行时间和资源使用率
- 合理分配 CPU 时间片

## 通用控制系统规范

### 1. 安全机制

- 多层安全保护：硬件+软件双重保护
- 故障检测：过流、过压、过温、通信故障
- 安全状态：系统故障时进入安全模式
- 看门狗机制：防止系统死锁
- 参数范围检查：防止异常输入

### 2. 控制算法

- 算法参数可配置，支持在线调整
- 滤波器设计考虑噪声和延迟平衡
- 控制周期稳定，避免时序抖动
- 状态机设计清晰，转换条件明确
- 算法实现考虑数值稳定性

### 3. 通信协议

- 协议设计考虑可靠性和实时性
- 数据校验：CRC、奇偶校验等
- 超时处理：重发机制、故障恢复
- 流控机制：防止数据丢失
- 命令确认：关键操作需要应答

## 调试与测试规范

### 1. ESP32 日志系统

- **日志级别**：ERROR > WARN > INFO > DEBUG > VERBOSE
- **关键路径**：必须有 INFO 级别日志
- **错误处理**：必须有 ERROR 级别日志
- **调试信息**：使用 DEBUG/VERBOSE 级别
- **生产环境**：可关闭调试日志节省资源
- **日志格式**：使用 ESP_LOG 系列宏

### 2. 断言与检查

- **参数检查**：NULL 指针、数组越界、数值范围
- **状态检查**：模块初始化、设备连接状态
- **返回值检查**：所有系统调用必须检查
- **边界检查**：缓冲区溢出、资源耗尽
- **使用 assert()**：检查关键条件

### 3. 性能监控

- **执行时间**：使用`esp_timer_get_time()`测量
- **内存监控**：`heap_caps_get_free_size()`检查可用内存
- **任务监控**：`uxTaskGetStackHighWaterMark()`检查栈使用
- **CPU 使用率**：识别性能瓶颈
- **关键指标**：响应时间、吞吐量记录

## 文档与注释规范

### 1. 代码注释

- **文件头**：版权信息、文件描述、作者、日期
- **函数注释**：使用 Doxygen 风格

```c
/**
 * @brief  函数简要说明
 * @param  参数说明
 * @retval 返回值说明
 */
```

- **复杂算法**：流程图、关键步骤说明
- **配置参数**：默认值、取值范围说明

### 2. 项目文档

- **README.md**：项目说明、环境配置、使用方法
- **API 文档**：使用 Doxygen 生成
- **硬件文档**：引脚定义、接口说明

## AI 编程助手优化配置

### 1. 代码生成策略

- **优先级**：项目内函数/变量 > ESP-IDF API > 标准库
- **自动补全**：智能导入头文件，生成错误处理代码
- **上下文感知**：基于现有代码模式生成一致性代码
- **注释生成**：自动添加 Doxygen 风格注释

### 2. 重构与优化

- **代码重构**：提取重复代码，优化性能瓶颈
- **内存优化**：改进内存使用效率，检测泄漏风险
- **可读性**：增强代码可读性，保持风格一致
- **ESP32 优化**：利用硬件特性，优化实时性能

### 3. 错误检测与预防

- **静态分析**：代码质量检查，潜在问题识别
- **运行时检查**：内存泄漏、死锁风险检测
- **性能分析**：识别性能瓶颈，优化关键路径
- **安全检查**：缓冲区溢出、空指针访问检测

## ESP32-S3 特定约束

### 1. 严格禁止

- ❌ 关键路径使用动态内存分配
- ❌ ISR 中使用浮点运算或复杂计算
- ❌ 实时任务中使用阻塞 I/O
- ❌ 递归调用（栈溢出风险）
- ❌ 未初始化变量使用
- ❌ 在 ISR 中调用 FreeRTOS API（除 FromISR 版本）

### 2. 强制要求

- ✅ 全局变量必须初始化
- ✅ 系统调用必须检查返回值
- ✅ 资源申请/释放必须配对
- ✅ 中断必须正确清除标志
- ✅ 关键数据必须校验
- ✅ 任务栈大小必须合理设置

### 3. 性能优化建议

- 🔧 优先使用整数运算
- 🔧 查表法替代复杂数学计算
- 🔧 环形缓冲区管理数据流
- 🔧 状态机管理复杂逻辑
- 🔧 位操作提高执行效率
- 🔧 使用 ESP32 硬件加速功能

## 代码审查检查清单

### 功能与逻辑

- [ ] 逻辑正确性验证
- [ ] 边界条件处理
- [ ] 错误情况考虑
- [ ] 实时性要求满足

### 代码质量

- [ ] 命名规范一致
- [ ] 注释充分清晰
- [ ] 代码结构合理
- [ ] 风格保持一致

### 性能与安全

- [ ] 内存使用合理
- [ ] 性能瓶颈检查
- [ ] 资源正确释放
- [ ] 并发安全保证

---

## 总结

本规范指南专为 ESP32-S3 嵌入式开发定制，涵盖了从代码编写到项目管理的全流程规范。遵循这些规范可以：

- 🎯 **提高代码质量**：统一的编码标准和最佳实践
- 🚀 **提升开发效率**：AI 助手优化配置和自动化工具
- 🛡️ **增强系统稳定性**：完善的错误处理和安全机制
- 📈 **优化系统性能**：针对 ESP32 平台的性能优化策略
- 🔧 **简化维护工作**：清晰的文档和规范的代码结构

请在开发过程中严格遵循本规范，确保项目的高质量交付。
